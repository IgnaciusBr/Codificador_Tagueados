<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Linker - Classificador Fiscal com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Customizando o tema do Tailwind para uma paleta mais profissional
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            '50': '#eff6ff',
                            '100': '#dbeafe',
                            '200': '#bfdbfe',
                            '300': '#93c5fd',
                            '400': '#60a5fa',
                            '500': '#3b82f6',
                            '600': '#2563eb',
                            '700': '#1d4ed8',
                            '800': '#1e40af',
                            '900': '#1e3a8a',
                        },
                        slate: {
                            '50': '#f8fafc',
                            '100': '#f1f5f9',
                            '200': '#e2e8f0',
                            '300': '#cbd5e1',
                            '400': '#94a3b8',
                            '500': '#64748b',
                            '600': '#475569',
                            '700': '#334155',
                            '800': '#1e293b',
                            '900': '#0f172a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* bg-slate-50 */
        }
        .loader {
            border: 4px solid #e2e8f0; /* border-slate-200 */
            border-top: 4px solid #3b82f6; /* border-primary-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tab-active {
            border-color: #3b82f6; /* border-primary-500 */
            color: #2563eb; /* text-primary-600 */
        }
        .drop-zone {
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Cabeçalho -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-3">
                    <svg class="h-8 w-8 text-primary-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                       <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
                    </svg>
                    <span class="text-xl font-bold text-slate-900">Code Linker</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <main>
            <!-- Seção de Configuração Inicial -->
            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md border border-slate-200 mb-8">
                <h2 class="text-2xl font-semibold mb-1 text-slate-900">Configuração Inicial</h2>
                <p class="text-slate-500 mb-6">Forneça sua chave de API e as tabelas de referência para começar.</p>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <label for="api-key-input" class="block text-md font-semibold text-slate-700">Chave de API do Gemini</label>
                        <input type="password" id="api-key-input" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-lg shadow-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" placeholder="Cole sua chave de API aqui">
                        <p class="text-sm text-slate-500">Sua chave é usada apenas no seu navegador. Obtenha uma no <a href="https://aistudio.google.com/app/apikey" target="_blank" class="font-medium text-primary-600 hover:underline">Google AI Studio</a>.</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <h3 class="font-semibold text-slate-700 mb-2">Tabela TIPI</h3>
                            <div id="drop-zone-tipi" class="drop-zone border-2 border-dashed border-slate-300 rounded-lg p-4 text-center cursor-pointer hover:border-primary-500 hover:bg-primary-50">
                                <input type="file" id="file-input-tipi" class="hidden" accept=".xlsx, .xls">
                                <p class="text-sm font-medium text-slate-700">Carregar Arquivo</p>
                                <p id="file-name-tipi" class="mt-1 text-xs font-medium text-green-600"></p>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-slate-700 mb-2">Tabela de Categorias</h3>
                            <div id="drop-zone-categories" class="drop-zone border-2 border-dashed border-slate-300 rounded-lg p-4 text-center cursor-pointer hover:border-primary-500 hover:bg-primary-50">
                                <input type="file" id="file-input-categories" class="hidden" accept=".xlsx, .xls">
                                <p class="text-sm font-medium text-slate-700">Carregar Arquivo</p>
                                <p id="file-name-categories" class="mt-1 text-xs font-medium text-green-600"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Abas de Navegação -->
            <div class="mb-8 border-b border-slate-200">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button id="tab-ncm" class="whitespace-nowrap py-4 px-1 border-b-2 font-semibold text-lg border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300">Associar NCM</button>
                    <button id="tab-category" class="whitespace-nowrap py-4 px-1 border-b-2 font-semibold text-lg border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300">Associar Categoria</button>
                </nav>
            </div>

            <!-- Conteúdo das Abas -->
            <div id="tab-content">
                <!-- Aba NCM -->
                <div id="view-ncm" class="hidden">
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md border border-slate-200">
                        <h2 class="text-2xl font-semibold mb-1 text-slate-900">Classificação de NCM</h2>
                        <p class="text-slate-500 mb-6">Faça o upload da sua lista de produtos para associar os códigos NCM.</p>
                        <div id="drop-zone-products-ncm" class="drop-zone border-2 border-dashed border-slate-300 rounded-lg p-8 text-center cursor-pointer hover:border-primary-500 hover:bg-primary-50">
                            <input type="file" id="file-input-products-ncm" class="hidden" accept=".xlsx, .xls">
                            <svg class="mx-auto h-12 w-12 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3.75 18A2.25 2.25 0 006 20.25h12A2.25 2.25 0 0020.25 18v-2.25A2.25 2.25 0 0018 13.5H6a2.25 2.25 0 00-2.25 2.25V18z" /></svg>
                            <p class="mt-2 font-semibold text-primary-600">Clique para carregar ou arraste o arquivo</p>
                            <p class="text-xs text-slate-500">Colunas esperadas: 'Código', 'Descritivo'</p>
                            <p id="file-name-products-ncm" class="mt-4 font-medium text-slate-700 text-sm"></p>
                        </div>
                        <div class="mt-6 text-center">
                            <button id="process-btn-ncm" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-primary-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-primary-700 disabled:bg-slate-400 disabled:cursor-not-allowed transition-colors" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.562L16.5 21.75l-.398-1.188a3.375 3.375 0 00-2.456-2.456L12.75 18l1.188-.398a3.375 3.375 0 002.456-2.456L16.5 14.25l.398 1.188a3.375 3.375 0 002.456 2.456L20.25 18l-1.188.398a3.375 3.375 0 00-2.456 2.456z" /></svg>
                                Processar NCM
                            </button>
                        </div>
                        <div id="loading-ncm" class="text-center my-6 hidden"><div class="loader inline-block"></div><p class="mt-2 text-slate-600 font-medium"></p></div>
                        <div id="results-ncm" class="mt-8 hidden">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                                <h3 class="text-xl font-semibold text-slate-900">Resultados NCM</h3>
                                <button id="copy-btn-ncm" class="mt-2 sm:mt-0 flex items-center gap-2 bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m9.375 0V9.375c0-.621-.504-1.125-1.125-1.125H1.875e-05" /></svg>
                                    Copiar
                                </button>
                            </div>
                            <div class="overflow-x-auto rounded-lg border border-slate-200"><table id="results-table-ncm" class="min-w-full bg-white"></table></div>
                        </div>
                    </div>
                </div>

                <!-- Aba Categoria -->
                <div id="view-category" class="hidden">
                     <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md border border-slate-200">
                        <h2 class="text-2xl font-semibold mb-1 text-slate-900">Classificação de Categoria</h2>
                        <p class="text-slate-500 mb-6">Faça o upload da sua lista de produtos para associar as categorias.</p>
                        <div id="drop-zone-products-category" class="drop-zone border-2 border-dashed border-slate-300 rounded-lg p-8 text-center cursor-pointer hover:border-primary-500 hover:bg-primary-50">
                            <input type="file" id="file-input-products-category" class="hidden" accept=".xlsx, .xls">
                            <svg class="mx-auto h-12 w-12 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3.75 18A2.25 2.25 0 006 20.25h12A2.25 2.25 0 0020.25 18v-2.25A2.25 2.25 0 0018 13.5H6a2.25 2.25 0 00-2.25 2.25V18z" /></svg>
                            <p class="mt-2 font-semibold text-primary-600">Clique para carregar ou arraste o arquivo</p>
                            <p class="text-xs text-slate-500">Colunas esperadas: 'Código', 'Descritivo'</p>
                            <p id="file-name-products-category" class="mt-4 font-medium text-slate-700 text-sm"></p>
                        </div>
                        <div class="mt-6 text-center">
                            <button id="process-btn-category" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-primary-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-primary-700 disabled:bg-slate-400 disabled:cursor-not-allowed transition-colors" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.562L16.5 21.75l-.398-1.188a3.375 3.375 0 00-2.456-2.456L12.75 18l1.188-.398a3.375 3.375 0 002.456-2.456L16.5 14.25l.398 1.188a3.375 3.375 0 002.456 2.456L20.25 18l-1.188.398a3.375 3.375 0 00-2.456 2.456z" /></svg>
                                Processar Categoria
                            </button>
                        </div>
                        <div id="loading-category" class="text-center my-6 hidden"><div class="loader inline-block"></div><p class="mt-2 text-slate-600 font-medium"></p></div>
                        <div id="results-category" class="mt-8 hidden">
                           <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                                <h3 class="text-xl font-semibold text-slate-900">Resultados Categoria N3</h3>
                                <button id="copy-btn-category" class="mt-2 sm:mt-0 flex items-center gap-2 bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m9.375 0V9.375c0-.621-.504-1.125-1.125-1.125H1.875e-05" /></svg>
                                    Copiar
                                </button>
                            </div>
                            <div class="overflow-x-auto rounded-lg border border-slate-200"><table id="results-table-category" class="min-w-full bg-white"></table></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="message-box" class="fixed top-5 right-5 mt-4 mr-4 p-4 rounded-lg text-center font-medium shadow-lg hidden transition-transform duration-300 translate-x-full"></div>
        </main>
    </div>

    <script>
        const apiKeyInput = document.getElementById('api-key-input');
        const messageBox = document.getElementById('message-box');
        const tabNcm = document.getElementById('tab-ncm');
        const tabCategory = document.getElementById('tab-category');
        const viewNcm = document.getElementById('view-ncm');
        const viewCategory = document.getElementById('view-category');

        let tipiData = new Map();
        let categoriesData = [];
        let productsDataNcm = [];
        let productsDataCategory = [];

        function switchTab(activeTab) {
            const isNcm = activeTab === 'ncm';
            viewNcm.classList.toggle('hidden', !isNcm);
            viewCategory.classList.toggle('hidden', isNcm);
            tabNcm.classList.toggle('tab-active', isNcm);
            tabCategory.classList.toggle('tab-active', !isNcm);
        }
        tabNcm.addEventListener('click', () => switchTab('ncm'));
        tabCategory.addEventListener('click', () => switchTab('category'));
        switchTab('ncm');

        function setupUploader(dropZoneId, fileInputId, fileNameId, handlerFunction) {
            const dropZone = document.getElementById(dropZoneId);
            const fileInput = document.getElementById(fileInputId);
            const fileNameDisplay = document.getElementById(fileNameId);
            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-primary-500', 'bg-primary-50'); });
            dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('border-primary-500', 'bg-primary-50'); });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-primary-500', 'bg-primary-50');
                if (e.dataTransfer.files.length) handlerFunction(e.dataTransfer.files[0], fileNameDisplay);
            });
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) handlerFunction(e.target.files[0], fileNameDisplay);
            });
        }

        setupUploader('drop-zone-tipi', 'file-input-tipi', 'file-name-tipi', handleTipiFile);
        setupUploader('drop-zone-categories', 'file-input-categories', 'file-name-categories', handleCategoriesFile);
        setupUploader('drop-zone-products-ncm', 'file-input-products-ncm', 'file-name-products-ncm', (file, display) => handleProductsFile(file, display, 'ncm'));
        setupUploader('drop-zone-products-category', 'file-input-products-category', 'file-name-products-category', (file, display) => handleProductsFile(file, display, 'category'));

        function handleFile(file, fileNameDisplay, validationFn) {
            fileNameDisplay.textContent = file.name;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    validationFn(worksheet);
                } catch (error) {
                    showMessage(error.message || 'Erro ao ler o arquivo.', 'error');
                }
            };
            reader.onerror = () => showMessage('Não foi possível ler o arquivo.', 'error');
            reader.readAsArrayBuffer(file);
        }

        function handleTipiFile(file, fileNameDisplay) {
            handleFile(file, fileNameDisplay, (worksheet) => {
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                if (jsonData.length > 0 && 'NCM' in jsonData[0] && 'DESCRIÇÃO' in jsonData[0]) {
                    tipiData.clear();
                    jsonData.forEach(row => tipiData.set(String(row.NCM).replace(/\./g, '').trim(), String(row['DESCRIÇÃO']).trim()));
                    showMessage('Tabela TIPI carregada!', 'success');
                } else {
                    tipiData.clear();
                    throw new Error("Tabela TIPI deve ter colunas 'NCM' e 'DESCRIÇÃO'.");
                }
            });
        }

        function handleCategoriesFile(file, fileNameDisplay) {
            handleFile(file, fileNameDisplay, (worksheet) => {
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                const required = ['Categoria N3', 'Descrição N1', 'Descrição N2', 'Descrição N3'];
                if (jsonData.length > 0 && required.every(col => col in jsonData[0])) {
                    categoriesData = jsonData;
                    showMessage('Tabela de Categorias carregada!', 'success');
                } else {
                    categoriesData = [];
                    throw new Error(`Planilha de categorias deve ter as colunas: ${required.join(', ')}.`);
                }
            });
        }

        function handleProductsFile(file, fileNameDisplay, type) {
            handleFile(file, fileNameDisplay, (worksheet) => {
                const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                if (rows.length < 2) throw new Error("A planilha precisa de um cabeçalho e pelo menos uma linha de dados.");
                
                const headers = rows[0].map(h => String(h).trim());
                const codeIndex = headers.findIndex(h => h.toLowerCase() === 'código');
                const descIndex = headers.findIndex(h => h.toLowerCase() === 'descritivo');

                if (codeIndex === -1 || descIndex === -1) {
                    throw new Error("Planilha de produtos deve ter colunas 'Código' e 'Descritivo'.");
                }
                
                const jsonData = rows.slice(1).map(row => ({
                    'Código': row[codeIndex],
                    'Descritivo': row[descIndex]
                })).filter(item => item['Código']);

                if (jsonData.length > 0) {
                    if (type === 'ncm') {
                        productsDataNcm = jsonData;
                        document.getElementById('process-btn-ncm').disabled = false;
                    } else {
                        productsDataCategory = jsonData;
                        document.getElementById('process-btn-category').disabled = false;
                    }
                    showMessage(`Produtos para ${type.toUpperCase()} carregados!`, 'success');
                } else {
                    throw new Error("Nenhum dado de produto encontrado na planilha.");
                }
            });
        }
        
        async function process(type) {
            const btn = document.getElementById(`process-btn-${type}`);
            const loadingDiv = document.getElementById(`loading-${type}`);
            const loadingMessage = loadingDiv.querySelector('p');
            const resultsDiv = document.getElementById(`results-${type}`);
            
            resultsDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');
            btn.disabled = true;

            try {
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) throw new Error("Por favor, insira uma chave de API válida.");

                const batchSize = 200;
                let finalData = [];
                let resultsMap = new Map();
                const productsData = type === 'ncm' ? productsDataNcm : productsDataCategory;

                if (type === 'ncm' && tipiData.size === 0) throw new Error("Carregue a Tabela TIPI primeiro.");
                if (type === 'category' && categoriesData.length === 0) throw new Error("Carregue a Tabela de Categorias primeiro.");
                
                const batches = [];
                for (let i = 0; i < productsData.length; i += batchSize) {
                    batches.push(productsData.slice(i, i + batchSize));
                }
                
                let processedCount = 0;
                const totalCount = productsData.length;
                loadingMessage.textContent = `Processando... (0/${totalCount})`;

                const allResults = [];
                for (const batch of batches) {
                    const apiCall = type === 'ncm' ? getNCMsFromGeminiBatch(batch, apiKey) : getCategoriesFromGeminiBatch(batch, categoriesData, apiKey);
                    const batchResult = await apiCall;
                    allResults.push(...batchResult);
                    processedCount += batch.length;
                    loadingMessage.textContent = `Processando... (${processedCount}/${totalCount})`;
                }

                if (type === 'ncm') {
                    resultsMap = new Map(allResults.map(item => [String(item.codigo_original), item.ncm_sugerido]));
                    finalData = productsData.map(p => ({
                        'Código Original': p['Código'], 'Descritivo Original': p['Descritivo'],
                        'NCM Sugerido': formatNcmCode(resultsMap.get(String(p['Código'])) || 'Não encontrado'),
                        'Composição do NCM': buildNcmComposition(resultsMap.get(String(p['Código'])), tipiData)
                    }));
                    renderTable('ncm', finalData, ['Código Original', 'Descritivo Original', 'NCM Sugerido', 'Composição do NCM']);
                } else {
                    resultsMap = new Map(allResults.map(item => [String(item.codigo_original), item.categoria_sugerida]));
                    finalData = productsData.map(p => ({
                        'Código Original': p['Código'], 'Descritivo Original': p['Descritivo'],
                        'Categoria N3 Sugerida': resultsMap.get(String(p['Código'])) || 'Não encontrada'
                    }));
                    renderTable('category', finalData, ['Código Original', 'Descritivo Original', 'Categoria N3 Sugerida']);
                }
                resultsDiv.classList.remove('hidden');
                showMessage(`Processamento de ${type.toUpperCase()} concluído!`, 'success');
            } catch (error) {
                showMessage(error.message, 'error');
            } finally {
                loadingMessage.textContent = `Classificando...`;
                loadingDiv.classList.add('hidden');
                btn.disabled = false;
            }
        }

        document.getElementById('process-btn-ncm').addEventListener('click', () => process('ncm'));
        document.getElementById('process-btn-category').addEventListener('click', () => process('category'));

        async function callGeminiAPI(payload, apiKey) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(`Erro da API: ${err.error?.message || 'Verifique sua chave.'}`);
            }
            const result = await response.json();
            return JSON.parse(result.candidates[0].content.parts[0].text);
        }

        async function getNCMsFromGeminiBatch(products, apiKey) {
            const prompt = `Analise os produtos e retorne o código NCM de 8 dígitos para cada um. Responda em JSON com "codigo_original" e "ncm_sugerido".\n\nProdutos:\n${products.map(p => `Código: ${p.Código}, Descritivo: ${p.Descritivo}`).join('\n')}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { "codigo_original": { "type": "STRING" }, "ncm_sugerido": { "type": "STRING" } }, required: ["codigo_original", "ncm_sugerido"] } } } };
            return callGeminiAPI(payload, apiKey);
        }

        async function getCategoriesFromGeminiBatch(products, categories, apiKey) {
            const prompt = `Para cada produto, encontre o 'Código Categoria' mais apropriado da lista. Responda em JSON com "codigo_original" e "categoria_sugerida".\n\nProdutos:\n${products.map(p => `Código: ${p.Código}, Descritivo: ${p.Descritivo}`).join('\n')}\n\nCategorias:\n${categories.map(c => `Código Categoria: ${c['Categoria N3']}, Descrições: ${c['Descrição N1']} - ${c['Descrição N2']} - ${c['Descrição N3']}`).join('\n')}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { "codigo_original": { "type": "STRING" }, "categoria_sugerida": { "type": "STRING" } }, required: ["codigo_original", "categoria_sugerida"] } } } };
            return callGeminiAPI(payload, apiKey);
        }
        
        function formatNcmCode(ncm) {
            const ncmStr = String(ncm).replace(/\D/g, '');
            if (ncmStr.length !== 8) return ncm;
            return `${ncmStr.slice(0, 4)}.${ncmStr.slice(4, 6)}.${ncmStr.slice(6, 8)}`;
        }

        function buildNcmComposition(ncmCode, tipi) {
            const ncm = String(ncmCode).replace(/\D/g, '');
            if (ncm.length !== 8 || tipi.size === 0) return 'N/A';
            const keys = [...new Set([ncm.slice(0, 4), ncm.slice(0, 5), ncm.slice(0, 6), ncm])];
            return keys.map(key => tipi.get(key)).filter(Boolean).join(' > ') || 'Descrição não encontrada';
        }

        function renderTable(type, data, headers) {
            const table = document.getElementById(`results-table-${type}`);
            table.innerHTML = '';
            const thead = table.createTHead();
            thead.className = 'bg-slate-100';
            let headerRow = thead.insertRow();
            headers.forEach(key => {
                let th = document.createElement('th');
                th.className = 'px-4 py-3 border-b-2 border-slate-200 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider';
                th.textContent = key;
                headerRow.appendChild(th);
            });

            const tbody = table.createTBody();
            data.forEach(item => {
                let row = tbody.insertRow();
                row.className = 'hover:bg-slate-50';
                headers.forEach(header => {
                    let cell = row.insertCell();
                    cell.className = 'px-4 py-3 border-b border-slate-200 text-sm text-slate-700';
                    if (header === 'NCM Sugerido') cell.classList.add('font-mono');
                    cell.textContent = item[header];
                });
            });
        }

        function copyTable(type) {
            const table = document.getElementById(`results-table-${type}`);
            let text = Array.from(table.querySelectorAll('tr')).map(row => 
                Array.from(row.querySelectorAll('th, td')).map(cell => cell.innerText).join('\t')
            ).join('\n');
            
            const textArea = document.createElement('textarea');
            textArea.style.position = 'fixed'; textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showMessage('Tabela copiada!', 'success');
            } catch (err) {
                showMessage('Falha ao copiar.', 'error');
            }
            document.body.removeChild(textArea);
        }
        document.getElementById('copy-btn-ncm').addEventListener('click', () => copyTable('ncm'));
        document.getElementById('copy-btn-category').addEventListener('click', () => copyTable('category'));

        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = 'fixed top-5 right-5 p-4 rounded-lg text-center font-medium shadow-lg transition-transform duration-300';
            if (type === 'success') messageBox.classList.add('bg-green-100', 'text-green-800');
            else if (type === 'error') messageBox.classList.add('bg-red-100', 'text-red-800');
            
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.remove('translate-x-full'), 10);
            
            setTimeout(() => { messageBox.classList.add('translate-x-full'); }, 4500);
            setTimeout(() => { messageBox.classList.add('hidden'); }, 5000);
        }
    </script>
</body>
</html>
